{% for service in ("redmine", "gerrit", "nodepool", "etherpad", "lodgeit", "gnocchi", "grafana") %}
  {% if service in groups %}
CREATE DATABASE IF NOT EXISTS {{ service }} CHARACTER SET utf8 COLLATE utf8_general_ci;
GRANT ALL PRIVILEGES ON {{ service }}.* TO '{{ service }}'@'localhost' IDENTIFIED BY "{{ hostvars[inventory_hostname]["creds_%s_sql_pwd" % service] }}" WITH GRANT OPTION;
    {% for host in groups[service] %}
GRANT ALL PRIVILEGES ON {{ service }}.* TO '{{ service }}'@'{{ host }}' IDENTIFIED BY "{{ hostvars[inventory_hostname]["creds_%s_sql_pwd" % service] }}" WITH GRANT OPTION;
    {% endfor %}
  {% elif service in ("gnocchi", "grafana") %}
CREATE DATABASE IF NOT EXISTS {{ service }} CHARACTER SET utf8 COLLATE utf8_general_ci;
    {% if "statsd" in groups %}
      {% for host in groups["statsd"] %}
GRANT ALL PRIVILEGES ON {{ service }}.* TO '{{ service }}'@'{{ host }}' IDENTIFIED BY "{{ hostvars[inventory_hostname]["creds_%s_sql_pwd" % service] }}" WITH GRANT OPTION;
      {% endfor %}
    {% endif %}
  {% endif %}
{% endfor %}
FLUSH PRIVILEGES;
