# -*- shell-script -*-

ORIG=${SDIR}/build
SRC=$(cd $(dirname $0); pwd)

function install_pip {
    do_chroot $dir wget http://codybonney.com/files/packages/python/ez_setup.py
    do_chroot $dir python ez_setup.py
    do_chroot $dir easy_install pip
}

function pin_local {
    local dist=$1
    local dir=$2
    local priority=$3

    check_usage $# 3 "pin_repository <dist> <chroot> <priority>"
}

function put_git_mark {
    local dir=$1
    sha=`git rev-parse HEAD`
    echo $sha >> $dir/etc/SF_GIT_COMMIT
}

function install_bup {
    local dir=$1
    if [ -d "${dir}/etc/apt/" ]; then
        # This is only usage on yum based dist
        return
    fi
    install_packages $dir "cpp gcc python-devel pyxattr pylibacl perl-Time-HiRes"
    do_chroot $dir mkdir -p /opt/bup
    do_chroot $dir git clone https://github.com/bup/bup.git /opt/bup/
    do_chroot $dir bash -c 'cd /opt/bup && git checkout 0.26'
    do_chroot $dir bash -c 'cd /opt/bup && ./configure && make && make install'
}

function http_fetch {
    local remote_location=$1
    local local_location=$2
    # We retry 12 times with 10 seconds delay between retries
    curl --silent --show-error --retry 12 --retry-delay 10 -L -o $local_location $remote_location
}

function disable_selinux {
    if [ -f "${dir}/etc/selinux/config" ]; then
        sed -i "s/^SELINUX=.*/SELINUX=disabled/" "${dir}/etc/selinux/config"
    fi
}

function retry {
    # This is a really dumb retry function
    local max_retries=3
    local delay=3
    for i in $(seq $max_retries); do
        $@ && break
        echo "The command return $? as error code. Retry (attempt $i) ..."
        sleep $delay
    done
}

. ${ORIG}/functions
