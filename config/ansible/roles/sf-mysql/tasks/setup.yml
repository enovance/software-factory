---
- include_vars: /etc/puppet/hiera/sf/sfcreds.yaml

- name: Set character_set_server to utf8
  lineinfile:
      dest: /etc/my.cnf
      line: "character_set_server = utf8"

- name: Start service
  service: name=mariadb enabled=yes state=started

- name: Check mysql root password
  shell: "/usr/bin/mysqladmin -u root -p{{ mysql_root_password }} status"
  register: mysql_root_password_set

- name: Set mysql root password
  shell: "/usr/bin/mysqladmin -u root password {{ mysql_root_password }}"
  register: result
  until: result.rc == 0
  retries: 5
  delay: 1
  when: not mysql_root_password_set

- name: Install initialization and backup/restore scripts
  template:
    src: "{{ item.name }}.j2"
    dest: "/root/{{ item.realname | default(item.name) }}"
    owner: root
    group: root
    mode: "{{ item.mode | default('0740')}}"
  with_items:
    - { name: backup_mysql.sh }
    - { name: restore_mysql.sh }
    - { name: create_databases.sql }
    - { name: client.cnf, realname: .my.cnf, mode: '0400' }

- name: Delete anonymous MySQL server user for $ansible_hostname
  action: mysql_user user="" host="{{ ansible_hostname }}" state="absent"

- name: Delete anonymous MySQL server user for localhost
  action: mysql_user user="" state="absent"

- name: Remove the MySQL test database
  action: mysql_db db=test state=absent

- name: Create databases
  shell: "mysql < /root/create_databases.sql"
