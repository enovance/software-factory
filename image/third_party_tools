# -*- shell-script -*-

# puppet
PUPPET_CODENAME_MAJOR=7
PUPPET_REPO_VERSION="${PUPPET_CODENAME_MAJOR}-11"
PUPPET_REPO_URL="http://yum.puppetlabs.com/el/${PUPPET_CODENAME_MAJOR}/products/x86_64/puppetlabs-release-${PUPPET_REPO_VERSION}.noarch.rpm"

URL_LIST="$URL_LIST $PUPPET_REPO_URL"

# pip
export PIP_USE_MIRRORS=True
#PIP_MIRROR_URL=http://your/pip/mirror/here
#export PIP_EXTRA_INDEX_URL=$PIP_MIRROR_URL

#URL_LIST="$URL_LIST $PIP_MIRROR_URL"

# rubygem
#RUBY_MIRROR_URL=http://your/rubygems/mirror/here
#gem source -a $RUBY_MIRROR_URL

#URL_LIST="$URL_LIST $RUBY_MIRROR_URL"

# Serverspec gem versions
SERVERSPEC_VERSION=2.25.0

# mod_auth_pubtkt
MOD_AUTH_PUBTKT_VERSION=0.8
MOD_AUTH_PUBTKT_URL="https://neon1.net/mod_auth_pubtkt/mod_auth_pubtkt-${MOD_AUTH_PUBTKT_VERSION}.tar.gz"

URL_LIST="$URL_LIST $MOD_AUTH_PUBTKT_URL"

# redmine
REDMINE_VERSION=2.6.9
REDMINE_RHEL_URL="http://www.redmine.org/releases/redmine-${REDMINE_VERSION}.tar.gz"
REDMINE_BACKLOG_URL="git://github.com/backlogs/redmine_backlogs.git"
REDMINE_HTTP_PLUGIN_URL="git://github.com/kevinfoote/redmine_http_auth.git"

URL_LIST="$URL_LIST $REDMINE_RHEL_URL"
GIT_REPO_LIST="$GIT_REPO_LIST $REDMINE_BACKLOG_URL $REDMINE_HTTP_PLUGIN_URL"

# bup
BUP_URL="https://github.com/bup/bup.git"
BUP_VERSION=0.26

GIT_REPO_LIST="$GIT_REPO_LIST $BUP_URL"

# gerrit
GERRIT_VERSION=2.11.5
GERRIT_URL="http://gerrit-releases.storage.googleapis.com/gerrit-${GERRIT_VERSION}.war"
MYSQLJAVA_VERSION=5.1.21
MYSQLJAVA_URL="http://repo2.maven.org/maven2/mysql/mysql-connector-java/${MYSQLJAVA_VERSION}/mysql-connector-java-${MYSQLJAVA_VERSION}.jar"
BCPROV_VERSION="151"
BCPROVJDK_VERSION="jdk15on"
BCPROVJAVA_URL="http://downloads.bouncycastle.org/java/bcprov-${BCPROVJDK_VERSION}-${BCPROV_VERSION}.jar"
BCPKIX_VERSION=$BCPROV_VERSION
BCPKIXJDK_VERSION=$BCPROVJDK_VERSION
BCPKIXJAVA_URL="http://downloads.bouncycastle.org/java/bcpkix-${BCPKIXJDK_VERSION}-${BCPKIX_VERSION}.jar"

URL_LIST="$URL_LIST $GERRIT_URL $MYSQLJAVA_URL $BCPROVJAVA_URL $BCPKIXJAVA_URL"

# bootstrap
BOOTSTRAP_VERSION=3.2.0
BOOTSTRAP_URL="https://github.com/twbs/bootstrap/releases/download/v${BOOTSTRAP_VERSION}/bootstrap-${BOOTSTRAP_VERSION}-dist.zip"

URL_LIST="$URL_LIST $BOOTSTRAP_URL"

# jenkins
export JENKINS_VERSION=1.580.3-1.1 # LTS
#export JENKINS_VERSION=1.609.1 # LTS 2015/05/29

# plugins
JENKINS_SWARM_VERSION=1.22
JENKINS_SWARM_CLIENT_URL="http://maven.jenkins-ci.org/content/repositories/releases/org/jenkins-ci/plugins/swarm-client/${JENKINS_SWARM_VERSION}/swarm-client-${JENKINS_SWARM_VERSION}-jar-with-dependencies.jar"
JENKINS_SWARM_PLUGIN_URL="http://repo.jenkins-ci.org/releases/org/jenkins-ci/plugins/swarm/${JENKINS_SWARM_VERSION}/swarm-${JENKINS_SWARM_VERSION}.hpi"

JENKINS_CREDENTIALS_BINDING_VERSION=1.4
JENKINS_CREDENTIALS_BINDING_URL="http://mirrors.jenkins-ci.org/plugins/credentials-binding/${JENKINS_CREDENTIALS_BINDING_VERSION}/credentials-binding.hpi"

JENKINS_WORKFLOW_STEP_API_VERSION=1.8
JENKINS_WORKFLOW_STEP_API_URL="http://mirrors.jenkins-ci.org/plugins/workflow-step-api/${JENKINS_WORKFLOW_STEP_API_VERSION}/workflow-step-api.hpi"

JENKINS_PLAIN_CREDENTIALS_VERSION=1.0
JENKINS_PLAIN_CREDENTIALS_URL="http://mirrors.jenkins-ci.org/plugins/plain-credentials/${JENKINS_PLAIN_CREDENTIALS_VERSION}/plain-credentials.hpi"

JENKINS_SSH_AGENT_PLUGIN_VERSION=1.4.1
JENKINS_SSH_AGENT_PLUGIN_URL="http://updates.jenkins-ci.org/download/plugins/ssh-agent/${JENKINS_SSH_AGENT_PLUGIN_VERSION}/ssh-agent.hpi"

JENKINS_GEARMAN_PLUGIN_VERSION=0.1.1
JENKINS_GEARMAN_PLUGIN_URL="http://updates.jenkins-ci.org/download/plugins/gearman-plugin/${JENKINS_GEARMAN_PLUGIN_VERSION}/gearman-plugin.hpi"

JENKINS_REVERSE_AUTH_PROXY_PLUGIN_VERSION=1.4.0
JENKINS_REVERSE_AUTH_PROXY_PLUGIN_URL="https://updates.jenkins-ci.org/download/plugins/reverse-proxy-auth-plugin/${JENKINS_REVERSE_AUTH_PROXY_PLUGIN_VERSION}/reverse-proxy-auth-plugin.hpi"

JENKINS_POST_BUILDSCRIPT_PLUGIN_VERSION=0.17
JENKINS_POST_BUILDSCRIPT_PLUGIN_URL="http://updates.jenkins-ci.org/download/plugins/postbuildscript/${JENKINS_POST_BUILDSCRIPT_PLUGIN_VERSION}/postbuildscript.hpi"

JENKINS_ANSI_COLOR_PLUGIN_VERSION=0.4.2
JENKINS_ANSI_COLOR_PLUGIN_URL="http://updates.jenkins-ci.org/download/plugins/ansicolor/${JENKINS_ANSI_COLOR_PLUGIN_VERSION}/ansicolor.hpi"

JENKINS_THEME_PLUGIN_URL="http://updates.jenkins-ci.org/latest/simple-theme-plugin.hpi"
JENKINS_ZMQ_PLUGIN_URL="http://mirrors.jenkins-ci.org/plugins/zmq-event-publisher/latest/zmq-event-publisher.hpi"
JENKINS_DASHBOARD_PLUGIN_URL="http://updates.jenkins-ci.org/latest/dashboard-view.hpi"
JENKINS_COBERTURA_URL="http://updates.jenkins-ci.org/latest/cobertura.hpi"

ZUUL_SWIFT_UPLOAD_URL="https://raw.githubusercontent.com/openstack-infra/project-config/master/jenkins/scripts/zuul_swift_upload.py"
URL_LIST="${URL_LIST} ${ZUUL_SWIFT_UPLOAD_URL}"

URL_LIST="$URL_LIST $JENKINS_SWARM_CLIENT_URL $JENKINS_SWARM_PLUGIN_URL $JENKINS_THEME_PLUGIN_URL $JENKINS_CREDENTIALS_BINDING_URL $JENKINS_CREDENTIALS_URL $JENKINS_WORKFLOW_STEP_API_URL $JENKINS_PLAIN_CREDENTIALS_URL $JENKINS_ZMQ_PLUGIN_URL $JENKINS_SSH_AGENT_PLUGIN_URL $JENKINS_GEARMAN_PLUGIN_URL $JENKINS_REVERSE_AUTH_PROXY_PLUGIN_URL $JENKINS_POST_BUILDSCRIPT_PLUGIN_URL $JENKINS_DASHBOARD_PLUGIN_URL $JENKINS_COBERTURA_URL $JENKINS_ANSI_COLOR_PLUGIN_URL"

# etherpad
ETHERPAD_LITE_VERSION=1.4.0
ETHERPAD_LITE_URL="https://codeload.github.com/ether/etherpad-lite/tar.gz/${ETHERPAD_LITE_VERSION}"

URL_LIST="$URL_LIST $ETHERPAD_LITE_URL"

# font awesome
FONTAWESOME_VERSION=4.2.0
FONTAWESOME_URL="https://codeload.github.com/FortAwesome/Font-Awesome/zip/v${FONTAWESOME_VERSION}"

URL_LIST="$URL_LIST $FONTAWESOME_URL"

# nodejs
NODEJS_NPM="https://www.npmjs.com/install.sh"
NPM_INSTALL=1.4.21
NPM_MIRROR_URL=http://registry.npmjs.org/

URL_LIST="$URL_LIST $NPM_MIRROR_URL $NODEJS_NPM"

# JQuery
JQUERY_VERSION=2.1.1
JQUERY_URL="http://code.jquery.com/jquery-${JQUERY_VERSION}.min.js"
JQUERY_VISIBILITY_URL="http://status.openstack.org/jquery-visibility.min.js"
JQUERY_GRAPHITE_URL="http://status.openstack.org/jquery-graphite.js"

URL_LIST="$URL_LIST $JQUERY_URL $JQUERY_VISIBILITY_URL $JQUERY_GRAPHITE_URL"

# AngularJS
ANGULARJS_VERSION=1.2.27
ANGULARJS_URL="https://ajax.googleapis.com/ajax/libs/angularjs/${ANGULARJS_VERSION}/angular.min.js"

URL_LIST="$URL_LIST $ANGULARJS_URL"

# zuul
ZUUL_URL="https://github.com/openstack-infra/zuul"
ZUUL_VERSION=fd463c84bfb342701061fe383c6d17e7a1bd4786

NODEPOOL_URL="https://github.com/openstack-infra/nodepool"
NODEPOOL_VERSION=0.1.1

URL_LIST="$URL_LIST $ZUUL_URL"

# paste (lodgeit)
PASTE_URL="https://git.openstack.org/openstack-infra/lodgeit"
PASTE_VERSION=beb3ff7e266 # latest commit as of 05 Jun 2015

GIT_REPO_LIST="$GIT_REPO_LIST $PASTE_URL"

GRAFANA_URL="https://grafanarel.s3.amazonaws.com/builds/grafana-2.5.0-1.x86_64.rpm"

URL_LIST="$URL_LIST $GRAFANA_URL"

#---- URL health check -------

function test_url {
  local e=0
  for url in $URL_LIST; do
    HTTP_CODE=$(curl -o /dev/null --silent --head --write-out '%{http_code}' "$url")

    if [ $HTTP_CODE -gt 399 ]
    then
      e=1
      echo "$url - Error $HTTP_CODE"
    else
      echo "$url - $HTTP_CODE"
    fi
  done;
  for repo in $GIT_REPO_LIST; do
    git ls-remote --exit-code $repo > /dev/null 2>&1
    if [ $? -gt 0 ]
    then
      echo "No matching refs for $repo"
      e=1
    else
      echo "$repo - 200"
    fi
  done;
  exit $e
}

# Packages (use image/sf.install STAGING_PKGS first to adds new packages without full cache rebuild)
#
BASE_PKGS="coreutils dhclient e2fsprogs man-db grub2 grubby initscripts iproute kernel"
BASE_PKGS="${BASE_PKGS} passwd redhat-lsb-core crontabs openssh-clients bind-utils kexec-tools"
BASE_PKGS="${BASE_PKGS} selinux-policy-targeted setroubleshoot-server acpid bash curl kbd lvm2"
BASE_PKGS="${BASE_PKGS} openssh-server pciutils rsync rsyslog sudo wget ntpdate logrotate"
BASE_PKGS="${BASE_PKGS} ethtool hdparm iptables git-review tmux net-tools"

BASE_TESTING_PKGS="python2-jenkins-job-builder python-statsd python2-voluptuous"

DEV_PKGS="openssl-devel openldap-devel python-devel libffi-devel gcc swig zlib-devel libcurl-devel"
DEV_PKGS="${DEV_PKGS} httpd-devel apr-devel apr-util-devel mariadb-devel gcc-c++ ruby-devel"
DEV_PKGS="${DEV_PKGS} ImageMagick-devel cpp libxml2-devel libxslt-devel"

PKGS="vim-enhanced openssl postfix bc ansible sshpass mod_passenger puppet rubygem-rake git"
PKGS="${PKGS} python-pip pyxattr pylibacl httpd mod_ssl ntp monit postfix nodejs httpd"
PKGS="${PKGS} java-1.7.0-openjdk mariadb-server python-werkzeug python-babel python-jinja2"
PKGS="${PKGS} MySQL-python socat mod_wsgi m2crypto mariadb gitweb debootstrap unzip pigz openssl"
PKGS="${PKGS} cloud-init cloud-utils-growpart memcached graphite-web statsd python-carbon mutt"
PKGS="${PKGS} python-testrepository PyYAML python-paramiko python-gear python-babel python-daemon"
PKGS="${PKGS} python-magic python-jenkins"

RDO_PKGS="${RDO_PKGS} python-swiftclient diskimage-builder python2-PyMySQL python-glanceclient"
RDO_PKGS="${RDO_PKGS} python-novaclient python-keystoneclient GitPython python-webob"
RDO_PKGS="${RDO_PKGS} openstack-gnocchi-api openstack-gnocchi-statsd openstack-gnocchi-metricd"
RDO_PKGS="${RDO_PKGS} python-ldap python2-passlib python-sqlalchemy python-urllib3"
RDO_PKGS="${RDO_PKGS} python-stevedore MySQL-python python-m2ext python-sphinx"
RDO_PKGS="${RDO_PKGS} python-ecdsa python2-pecan"

RPM_PKGS="${BASE_PKGS} ${BASE_TESTING_PKGS} ${DEV_PKGS} ${PKGS} ${RDO_PKGS} jenkins grafana"


# Pip Packages (use image/sf.install STAGING_PIP first to adds new packages without full cache rebuild)
#
# Pin Balel to 2.0 especially for the version of lodgeit we use
PIP_PKGS="Babel==2.0"
PIP_PKGS="${PIP_PKGS} pyopenssl ndg-httpsclient pyasn1 requests[security]"
PIP_PKGS="${PIP_PKGS} setuptools nose flake8 glob2 pycrypto"

# Graphite
PIP_PKGS="${PIP_PKGS}
django<1.8
django-tagging
"

# Sf requirement
PIP_PKGS="${PIP_PKGS}
python-redmine
gerritlib==0.4.0
basicauth==0.3
htpasswd
wsgiref==0.1.2
"
