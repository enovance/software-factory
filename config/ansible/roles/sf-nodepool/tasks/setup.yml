---
- include_vars: /etc/ansible/vars/common.yml
- include_vars: /etc/puppet/hiera/sf/sfconfig.yaml
- include_vars: /etc/puppet/hiera/sf/sfconfig.yaml


#   $arch = hiera('roles')
#   $jenkins_rsa_pub = hiera('jenkins_rsa_pub')
#   $nodepool = hiera('nodepool')
#   $fqdn = hiera('fqdn')
#   $jenkins_host = "jenkins.${fqdn}"

- include: /etc/ansible/tasks/create_user.yml user_name=nodepool ssh_key=jenkins_rsa

- name: Install backup procedure
  template: src="{{ item }}.sh.j2" dest="/root/{{ item }}_nodepool.sh" mode=0555
  with_items: ["backup", "restore"]

- name: Create working directories
  file:
      path: "{{ item.name }}"
      state: directory
      owner: "{{ item.user | default('nodepool') }}"
      group: "{{ item.group | default('root') }}"
      mode: "{{ item.mode | default(0550) }}"
  with_items:
    - {name: /etc/nodepool/scripts, user: root}
    - {name: /opt/nodepool}
    - {name: /var/log/nodepool, mode: '0700'}
    - {name: /var/run/nodepool}

- name: Install templates
  template:
      src: "{{ item.name }}.j2"
      dest: "{{item.dest }}/{{ item.name }}"
      owner: "{{ item.owner | default('root') }}"
      group: "{{ item.group | default('root') }}"
      mode: "{{ item.mode | default(0444) }}"
  with_items:
      - {name: _nodepool.yaml, dest: /etc/nodepool, owner: nodepool}
      - {name: secure.conf, dest: /etc/nodepool, group: nodepool, mode: '0440'}
      - {name: sf-nodepool-conf-update.sh, dest: /usr/local/bin, mode: '0555'}

# wait until we have decide which arch we will use
# for metrics
#- name: Install statsd configuration file
#  template:
#      src: statsd.environment.j2
#      dest: /etc/sysconfig/nodepool

- name: Install logging.conf
  copy:
      src: logging.conf
      dest: /etc/nodepool/logging.conf

- name: Setup authorized keys
  copy:
      content: "{{ jenkins_rsa_pub }}"
      dest: /etc/nodepool/scripts/authorized_keys

- name: Setup localCA
  copy:
      content: "{{ localCA_pem }}"
      dest: /etc/nodepool/scripts/localCA.pem

- name: Apply patches
  patch:
      src: "{{ item }}"
      basedir: /srv/nodepool/lib/python2.7/site-packages
      strip: 1
  with_items:
    - 272097-image-api-use-tasks.patch
    - 321480-Add-log-config-option-to-nodepool-cmd.patch

- name: Install service file
  copy:
      src: nodepool.service
      dest: /lib/systemd/system/nodepool.service
      owner: root
      group: root
      mode: 0644
  register: install_service_file
  when: nodepool.disabled == True

- name: Reload systemctl daemon
  shell: "systemctl daemon-reload"
  when:
      - install_service_file|changed
      - nodepool.disabled == True

- name: Start service
  service: name=nodepool enabled=yes state=started
  when: nodepool.disabled == True
