---
- name: Reset config
  command: chdir=config {{ item }}
  with_items:
    - git fetch --all
    - git reset --hard origin/master --

- name: Adds jjb project
  command: >
    hieraedit.py --yaml config/jobs/projects.yaml --eval 0 "{'project': {'name': 'nodepool-demo',
        'node': 'base-centos',
        'jobs': ['{name}-unit-tests']
      }}"

- name: Adds zuul project
  command: >
    hieraedit.py --yaml config/zuul/projects.yaml --eval projects "[{ 'name': 'nodepool-demo', 'check': ['nodepool-demo-unit-tests'] }]"


- name: Adds nodepool image
  command: >
    hieraedit.py --yaml config/nodepool/images.yaml --eval 0 "{
        'provider': 'default',
        'images': [{
            'name': 'centos7',
            'base-image': 'sf-C7.0-2.1.1',
            'username': 'centos',
            'private-key': '/var/lib/jenkins/.ssh/id_rsa',
            'setup': 'nodepool_demo.sh',
            'min-ram': 64
        }]
    }"

- name: Adds jjb project
  command: >
    hieraedit.py --yaml config/nodepool/labels.yaml --eval labels "[{'name': 'base-centos',
        'image': 'centos7',
        'min-ready': 1,
        'providers': [{'name': 'default'}]
    }]"

- name: Copy nodepool-demo image script
  copy: src=files/nodepool_demo.sh dest=config/nodepool/nodepool_demo.sh mode="u=rwx,g=rx,o=rx"

- name: Submit config change
  command: chdir=config {{ item }}
  with_items:
    - git add nodepool/nodepool_demo.sh
    - git commit -a -m "Adds nodepool-demo projects"
    - git config --add gitreview.username admin
    - git review -i
  environment:
    GIT_SSH: "/root/ssh_wrapper.sh"

- name: Get commit sha
  command: chdir=config bash -c "git show HEAD | grep '^commit' | awk '{ print $2 }'"
  register: commitsha

- name: Get change-Id
  command: chdir=config bash -c "git show HEAD | grep 'Change.Id:' | awk '{ print $2 }'"
  register: changeid

- name: Approve config repository update
  command: ssh -p 29418 sftests.com gerrit review --code-review +2 --workflow +1 {{ commitsha.stdout }}

- name: Wait for config-update to setup finish nodepool setup
  wait_for: path=/etc/nodepool/nodepool.yaml search_regex=sf-C7.0-2.1.1

- name: Check change was merged
  command: ssh -p 29418 sftests.com gerrit query "status:merged project:config"
  register: gerrit_query
  failed_when: "'{{ changeid.stdout }}' not in gerrit_query.stdout"
