#!/bin/sh

set -x
set -e

JENKINS_SSHKEY="<%= @gerrit_jenkins_sshkey %>"
ADMINUSER=admin

# Check if Jenkins user does not exist yet
JENKINS_USER_EXISTS=`ssh -i /home/gerrit/site_path/etc/ssh_host_rsa_key -p29418 $ADMINUSER@localhost gerrit ls-members \"Non-Interactive Users\" | { grep Jenkins || true; }`

if [ -z "$JENKINS_USER_EXISTS" ]; then
    echo "$JENKINS_SSHKEY" | ssh -i /home/gerrit/site_path/etc/ssh_host_rsa_key -p29418 $ADMINUSER@localhost gerrit create-account jenkins -g \"Non-Interactive Users\" --email admin@<%= @fqdn %> --full-name \"Jenkins CI\" --ssh-key -
fi
